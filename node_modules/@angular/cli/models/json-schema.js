"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
const core_1 = require("@angular-devkit/core");
const jsonSchemaTraverse = require("json-schema-traverse");
function convertSchemaToOptions(schema) {
    return __awaiter(this, void 0, void 0, function* () {
        const options = yield getOptions(schema);
        return options;
    });
}
exports.convertSchemaToOptions = convertSchemaToOptions;
function getOptions(schemaText, onlyRootProperties = true) {
    // TODO: Use devkit core's visitJsonSchema
    return new Promise((resolve) => {
        const fullSchema = core_1.parseJson(schemaText);
        if (!core_1.isJsonObject(fullSchema)) {
            return Promise.resolve([]);
        }
        const traverseOptions = {};
        const options = [];
        function postCallback(schema, jsonPointer, _rootSchema, _parentJsonPointer, parentKeyword, _parentSchema, property) {
            if (parentKeyword === 'properties') {
                let includeOption = true;
                if (onlyRootProperties && isPropertyNested(jsonPointer)) {
                    includeOption = false;
                }
                const description = typeof schema.description == 'string' ? schema.description : '';
                const type = typeof schema.type == 'string' ? schema.type : '';
                let defaultValue = undefined;
                if (schema.default !== null) {
                    if (typeof schema.default !== 'object') {
                        defaultValue = schema.default;
                    }
                }
                let $default = undefined;
                if (schema.$default !== null && core_1.isJsonObject(schema.$default)) {
                    $default = schema.$default;
                }
                let required = false;
                if (typeof schema.required === 'boolean') {
                    required = schema.required;
                }
                let aliases = undefined;
                if (typeof schema.aliases === 'object' && Array.isArray(schema.aliases)) {
                    aliases = schema.aliases;
                }
                let format = undefined;
                if (typeof schema.format === 'string') {
                    format = schema.format;
                }
                let hidden = false;
                if (typeof schema.hidden === 'boolean') {
                    hidden = schema.hidden;
                }
                const option = {
                    name: property,
                    // ...schema,
                    description,
                    type,
                    default: defaultValue,
                    $default,
                    required,
                    aliases,
                    format,
                    hidden,
                };
                if (includeOption) {
                    options.push(option);
                }
            }
            else if (schema === fullSchema) {
                resolve(options);
            }
        }
        const callbacks = { post: postCallback };
        jsonSchemaTraverse(fullSchema, traverseOptions, callbacks);
    });
}
function isPropertyNested(jsonPath) {
    return jsonPath.split('/')
        .filter(part => part == 'properties' || part == 'items')
        .length > 1;
}
function parseSchema(schema) {
    const parsedSchema = core_1.parseJson(schema);
    if (parsedSchema === null || !core_1.isJsonObject(parsedSchema)) {
        return null;
    }
    return parsedSchema;
}
exports.parseSchema = parseSchema;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianNvbi1zY2hlbWEuanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInBhY2thZ2VzL2FuZ3VsYXIvY2xpL21vZGVscy9qc29uLXNjaGVtYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUE7Ozs7OztHQU1HO0FBQ0gsK0NBQTJFO0FBQzNFLDJEQUEyRDtBQUczRCxTQUFzQixzQkFBc0IsQ0FBQyxNQUFjOztRQUN6RCxNQUFNLE9BQU8sR0FBRyxNQUFNLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUV6QyxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0NBQUE7QUFKRCx3REFJQztBQUVELFNBQVMsVUFBVSxDQUFDLFVBQWtCLEVBQUUsa0JBQWtCLEdBQUcsSUFBSTtJQUMvRCwwQ0FBMEM7SUFDMUMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQzdCLE1BQU0sVUFBVSxHQUFHLGdCQUFTLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLG1CQUFZLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDN0IsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQzVCO1FBQ0QsTUFBTSxlQUFlLEdBQUcsRUFBRSxDQUFDO1FBQzNCLE1BQU0sT0FBTyxHQUFhLEVBQUUsQ0FBQztRQUM3QixTQUFTLFlBQVksQ0FBQyxNQUFrQixFQUNsQixXQUFtQixFQUNuQixXQUFtQixFQUNuQixrQkFBMEIsRUFDMUIsYUFBcUIsRUFDckIsYUFBcUIsRUFDckIsUUFBZ0I7WUFDcEMsSUFBSSxhQUFhLEtBQUssWUFBWSxFQUFFO2dCQUNsQyxJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUM7Z0JBQ3pCLElBQUksa0JBQWtCLElBQUksZ0JBQWdCLENBQUMsV0FBVyxDQUFDLEVBQUU7b0JBQ3ZELGFBQWEsR0FBRyxLQUFLLENBQUM7aUJBQ3ZCO2dCQUNELE1BQU0sV0FBVyxHQUFHLE9BQU8sTUFB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LFlBQVksQ0FBQyxFQUFFO1FBQ3hELE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFFRCxPQUFPLFlBQVksQ0FBQztBQUN0QixDQUFDO0FBUEQsa0NBT0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5pbXBvcnQgeyBKc29uT2JqZWN0LCBpc0pzb25PYmplY3QsIHBhcnNlSnNvbiB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9jb3JlJztcbmltcG9ydCAqIGFzIGpzb25TY2hlbWFUcmF2ZXJzZSBmcm9tICdqc29uLXNjaGVtYS10cmF2ZXJzZSc7XG5pbXBvcnQgeyBPcHRpb24sIE9wdGlvblNtYXJ0RGVmYXVsdCB9IGZyb20gJy4vY29tbWFuZCc7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb252ZXJ0U2NoZW1hVG9PcHRpb25zKHNjaGVtYTogc3RyaW5nKTogUHJvbWlzZTxPcHRpb25bXT4ge1xuICBjb25zdCBvcHRpb25zID0gYXdhaXQgZ2V0T3B0aW9ucyhzY2hlbWEpO1xuXG4gIHJldHVybiBvcHRpb25zO1xufVxuXG5mdW5jdGlvbiBnZXRPcHRpb25zKHNjaGVtYVRleHQ6IHN0cmluZywgb25seVJvb3RQcm9wZXJ0aWVzID0gdHJ1ZSk6IFByb21pc2U8T3B0aW9uW10+IHtcbiAgLy8gVE9ETzogVXNlIGRldmtpdCBjb3JlJ3MgdmlzaXRKc29uU2NoZW1hXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgIGNvbnN0IGZ1bGxTY2hlbWEgPSBwYXJzZUpzb24oc2NoZW1hVGV4dCk7XG4gICAgaWYgKCFpc0pzb25PYmplY3QoZnVsbFNjaGVtYSkpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoW10pO1xuICAgIH1cbiAgICBjb25zdCB0cmF2ZXJzZU9wdGlvbnMgPSB7fTtcbiAgICBjb25zdCBvcHRpb25zOiBPcHRpb25bXSA9IFtdO1xuICAgIGZ1bmN0aW9uIHBvc3RDYWxsYmFjayhzY2hlbWE6IEpzb25PYmplY3QsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGpzb25Qb2ludGVyOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIF9yb290U2NoZW1hOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIF9wYXJlbnRKc29uUG9pbnRlcjogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRLZXl3b3JkOiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIF9wYXJlbnRTY2hlbWE6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydHk6IHN0cmluZykge1xuICAgICAgaWYgKHBhcmVudEtleXdvcmQgPT09ICdwcm9wZXJ0aWVzJykge1xuICAgICAgICBsZXQgaW5jbHVkZU9wdGlvbiA9IHRydWU7XG4gICAgICAgIGlmIChvbmx5Um9vdFByb3BlcnRpZXMgJiYgaXNQcm9wZXJ0eU5lc3RlZChqc29uUG9pbnRlcikpIHtcbiAgICAgICAgICBpbmNsdWRlT3B0aW9uID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZGVzY3JpcHRpb24gPSB0eXBlb2Ygc2NoZW1hLmRlc2NyaXB0aW9uID09ICdzdHJpbmcnID8gc2NoZW1hLmRlc2NyaXB0aW9uIDogJyc7XG4gICAgICAgIGNvbnN0IHR5cGUgPSB0eXBlb2Ygc2NoZW1hLnR5cGUgPT0gJ3N0cmluZycgPyBzY2hlbWEudHlwZSA6ICcnO1xuICAgICAgICBsZXQgZGVmYXVsdFZhbHVlOiBzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuICAgICAgICBpZiAoc2NoZW1hLmRlZmF1bHQgIT09IG51bGwpIHtcbiAgICAgICAgICBpZiAodHlwZW9mIHNjaGVtYS5kZWZhdWx0ICE9PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgZGVmYXVsdFZhbHVlID0gc2NoZW1hLmRlZmF1bHQ7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGxldCAkZGVmYXVsdDogT3B0aW9uU21hcnREZWZhdWx0IHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuICAgICAgICBpZiAoc2NoZW1hLiRkZWZhdWx0ICE9PSBudWxsICYmIGlzSnNvbk9iamVjdChzY2hlbWEuJGRlZmF1bHQpKSB7XG4gICAgICAgICAgJGRlZmF1bHQgPSBzY2hlbWEuJGRlZmF1bHQgYXMgT3B0aW9uU21hcnREZWZhdWx0O1xuICAgICAgICB9XG4gICAgICAgIGxldCByZXF1aXJlZCA9IGZhbHNlO1xuICAgICAgICBpZiAodHlwZW9mIHNjaGVtYS5yZXF1aXJlZCA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgICAgICAgcmVxdWlyZWQgPSBzY2hlbWEucmVxdWlyZWQ7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGFsaWFzZXM6IHN0cmluZ1tdIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuICAgICAgICBpZiAodHlwZW9mIHNjaGVtYS5hbGlhc2VzID09PSAnb2JqZWN0JyAmJiBBcnJheS5pc0FycmF5KHNjaGVtYS5hbGlhc2VzKSkge1xuICAgICAgICAgIGFsaWFzZXMgPSBzY2hlbWEuYWxpYXNlcyBhcyBzdHJpbmdbXTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgZm9ybWF0OiBzdHJpbmcgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG4gICAgICAgIGlmICh0eXBlb2Ygc2NoZW1hLmZvcm1hdCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICBmb3JtYXQgPSBzY2hlbWEuZm9ybWF0O1xuICAgICAgICB9XG4gICAgICAgIGxldCBoaWRkZW4gPSBmYWxzZTtcbiAgICAgICAgaWYgKHR5cGVvZiBzY2hlbWEuaGlkZGVuID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgICBoaWRkZW4gPSBzY2hlbWEuaGlkZGVuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgb3B0aW9uOiBPcHRpb24gPSB7XG4gICAgICAgICAgbmFtZTogcHJvcGVydHksXG4gICAgICAgICAgLy8gLi4uc2NoZW1hLFxuXG4gICAgICAgICAgZGVzY3JpcHRpb24sXG4gICAgICAgICAgdHlwZSxcbiAgICAgICAgICBkZWZhdWx0OiBkZWZhdWx0VmFsdWUsXG4gICAgICAgICAgJGRlZmF1bHQsXG4gICAgICAgICAgcmVxdWlyZWQsXG4gICAgICAgICAgYWxpYXNlcyxcbiAgICAgICAgICBmb3JtYXQsXG4gICAgICAgICAgaGlkZGVuLFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChpbmNsdWRlT3B0aW9uKSB7XG4gICAgICAgICAgb3B0aW9ucy5wdXNoKG9wdGlvbik7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoc2NoZW1hID09PSBmdWxsU2NoZW1hKSB7XG4gICAgICAgIHJlc29sdmUob3B0aW9ucyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgY2FsbGJhY2tzID0geyBwb3N0OiBwb3N0Q2FsbGJhY2sgfTtcblxuICAgIGpzb25TY2hlbWFUcmF2ZXJzZShmdWxsU2NoZW1hLCB0cmF2ZXJzZU9wdGlvbnMsIGNhbGxiYWNrcyk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBpc1Byb3BlcnR5TmVzdGVkKGpzb25QYXRoOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgcmV0dXJuIGpzb25QYXRoLnNwbGl0KCcvJylcbiAgICAuZmlsdGVyKHBhcnQgPT4gcGFydCA9PSAncHJvcGVydGllcycgfHwgcGFydCA9PSAnaXRlbXMnKVxuICAgIC5sZW5ndGggPiAxO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VTY2hlbWEoc2NoZW1hOiBzdHJpbmcpOiBKc29uT2JqZWN0IHwgbnVsbCB7XG4gIGNvbnN0IHBhcnNlZFNjaGVtYSA9IHBhcnNlSnNvbihzY2hlbWEpO1xuICBpZiAocGFyc2VkU2NoZW1hID09PSBudWxsIHx8ICFpc0pzb25PYmplY3QocGFyc2VkU2NoZW1hKSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcmV0dXJuIHBhcnNlZFNjaGVtYTtcbn1cbiJdfQ==